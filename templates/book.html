<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è¨‚ç¥¨ - {{ movie.title }}</title>
<style>
body {
    margin:0;
    font-family:"Segoe UI", Arial,sans-serif;
    background:linear-gradient(135deg,#1f2937,#111827);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:40px 0;
    color:#111;
}

/* å®¹å™¨ */
.booking-container {
    background:#fff;
    width:900px;
    max-width:95%;
    display:flex;
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 20px 40px rgba(0,0,0,0.4);
}

/* å·¦å´ï¼šæµ·å ± + å ´æ¬¡åˆ—è¡¨ */
.left-panel {
    width:40%;
    display:flex;
    flex-direction:column;
    align-items:center;
    background-color:#000;
    color:white;
}
.left-panel img {
    width:100%;
    object-fit:cover;
    border-bottom:1px solid rgba(255,255,255,0.1);
}
.movie-title {
    margin:15px 0 10px;
    font-size:24px;
    text-align:center;
}
.showtimes-list {
    width:90%;
    background-color:rgba(255,255,255,0.05);
    border-radius:8px;
    padding:10px;
    margin-bottom:20px;
}
.showtimes-list h3 {
    margin:0 0 10px;
    font-size:16px;
    text-align:center;
}
.showtimes-list ul {
    list-style:none;
    padding:0;
    margin:0;
}
.showtimes-list li {
    margin:4px 0;
    font-size:14px;
    text-align:center;
}

/* å³å´ï¼šè¨‚ç¥¨è¡¨å–® */
.booking-form {
    width:60%;
    padding:40px;
    display:flex;
    flex-direction:column;
}
.booking-form h2 {
    margin-top:0;
    margin-bottom:20px;
}
.error-box {
    display:none;
    background-color:#fee2e2;
    color:#b91c1c;
    border:1px solid #fca5a5;
    padding:10px;
    border-radius:6px;
    margin-bottom:15px;
    font-size:14px;
}
.form-group {
    margin-bottom:20px;
}
.form-group label {
    display:block;
    font-weight:bold;
    margin-bottom:6px;
}
.form-group input, .form-group select {
    width:100%;
    padding:10px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:15px;
}
.form-group input[readonly] {
    background-color:#f3f4f6;
}
.submit-btn {
    width:100%;
    padding:12px;
    font-size:16px;
    border:none;
    border-radius:8px;
    background-color:#16a34a;
    color:white;
    cursor:pointer;
}
.submit-btn[disabled] {
    background-color:#ccc;
    cursor:not-allowed;
}
.back-link {
    display:block;
    text-align:center;
    margin-top:15px;
    text-decoration:none;
    color:#2563eb;
}

/* éŸ¿æ‡‰å¼ */
@media (max-width: 800px) {
    .booking-container { flex-direction:column; }
    .left-panel, .booking-form { width:100%; }
}
</style>
</head>

<body>
<div class="booking-container">

    <!-- å·¦å´ï¼šæµ·å ± + æ‰€æœ‰å ´æ¬¡ -->
    <div class="left-panel">
        {% if movie.poster_url %}
            <img src="{{ url_for('static', filename=movie.poster_url) }}">
        {% else %}
            <img src="https://via.placeholder.com/400x600?text=No+Image">
        {% endif %}
        <div class="movie-title">{{ movie.title }}</div>

        {% if showtimes %}
        <div class="showtimes-list">
            <h3>ğŸ“… æ‰€æœ‰å ´æ¬¡</h3>
            <ul>
            {% for st in showtimes %}
                <li>
                    {{ st.weekday }} {{ st.showtime }}
                    {% if st.remaining_seats == 0 %}
                        ï¼ˆå·²å”®å®Œï¼‰
                    {% else %}
                        ï¼ˆå‰©é¤˜ {{ st.remaining_seats }} å¸­ï¼‰
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- å³å´ï¼šè¨‚ç¥¨è¡¨å–® -->
    <div class="booking-form">
        <h2>ç¢ºèªè¨‚ç¥¨è³‡è¨Š</h2>
        <div id="errorBox" class="error-box"></div>

        {% set available_showtimes = showtimes|selectattr("remaining_seats", "gt", 0)|list %}
        {% if available_showtimes %}
        <form method="post" id="bookingForm">
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" name="name" value="{{ session.get('username', '') }}" readonly>
            </div>

            <div class="form-group">
                <label>é¸æ“‡å ´æ¬¡</label>
                <select name="showtime_id" id="showtimeSelect" required>
                    {% for st in available_showtimes %}
                        <option value="{{ st.showtime_id }}">
                            {{ st.weekday }} {{ st.showtime }}ï¼ˆå‰©é¤˜ {{ st.remaining_seats }} å¸­ï¼‰
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>è³¼è²·å¼µæ•¸</label>
                <input type="number" id="tickets" name="tickets" min="1" value="1" step="1" required>
            </div>

            <button type="submit" class="submit-btn">ğŸŸ ç¢ºèªè¨‚ç¥¨</button>
        </form>
        {% else %}
            <div class="error-box" style="display:block;">âŒ æ‰€æœ‰å ´æ¬¡å·²å”®å®Œ</div>
            <button class="submit-btn" disabled>å·²å”®å®Œ</button>
        {% endif %}

        <a href="/" class="back-link">â† è¿”å›é›»å½±åˆ—è¡¨</a>
    </div>

</div>

<script>
const form = document.getElementById("bookingForm");
const ticketsInput = document.getElementById("tickets");
const showtimeSelect = document.getElementById("showtimeSelect");
const errorBox = document.getElementById("errorBox");

// æ¯å€‹å ´æ¬¡çš„å‰©é¤˜åº§ä½
const remainingSeatsMap = {
    {% for st in available_showtimes %}
        "{{ st.showtime_id }}": {{ st.remaining_seats }},
    {% endfor %}
};

if(form){
    form.addEventListener("submit", function (e) {
        e.preventDefault();
        errorBox.style.display = "none";

        const tickets = Number(ticketsInput.value);
        const selectedShowtimeId = showtimeSelect.value;
        const remainingSeats = remainingSeatsMap[selectedShowtimeId] || 0;

        if (!Number.isInteger(tickets) || tickets < 1) {
            errorBox.innerText = "è«‹è¼¸å…¥æ­£ç¢ºçš„è³¼ç¥¨å¼µæ•¸";
            errorBox.style.display = "block";
            return;
        }

        if (tickets > remainingSeats) {
            errorBox.innerText = `å‰©é¤˜åº§ä½åªæœ‰ ${remainingSeats} å¸­`;
            errorBox.style.display = "block";
            return;
        }

        fetch(window.location.pathname, {
            method: "POST",
            body: new FormData(form)
        })
        .then(async res => {
            if (!res.ok) {
                const msg = await res.text();
                errorBox.innerText = msg;
                errorBox.style.display = "block";
                return;
            }
            window.location.href = "/order";
        });
    });
}
</script>

</body>
</html>