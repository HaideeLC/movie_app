<!-- templates/order.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Ë®ÇÂñÆÊü•Ë©¢</title>
<style>
body { margin:0; font-family:"Segoe UI", Arial, sans-serif; min-height:100vh;
       background:url('https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?auto=format&fit=crop&w=1470&q=80') no-repeat center center fixed;
       background-size:cover; color:white; }
body::before { content:""; position:fixed; inset:0; background:inherit; filter:blur(12px) brightness(0.5); z-index:-1; }
.container { position:relative; z-index:1; max-width:1200px; margin:40px auto; padding:20px; background:rgba(0,0,0,0.5); border-radius:12px; }
.navbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.navbar a, .navbar span { color:white; text-decoration:none; font-weight:bold; margin-left:15px; }
.navbar a:hover { text-decoration:underline; }
.search-card { background:rgba(255,255,255,0.15); backdrop-filter:blur(6px); padding:20px; border-radius:12px; margin-bottom:30px; display:flex; justify-content:center; align-items:center; }
.search-input { flex:1; padding:12px 16px; border-radius:8px 0 0 8px; border:none; font-size:16px; outline:none; background-color:rgba(255,255,255,0.2); color:white; }
.search-input::placeholder { color:#e0e0e0; }
.search-btn { padding:12px 20px; border:none; border-radius:0 8px 8px 0; background:#2563eb; color:white; font-size:16px; cursor:pointer; }
.search-btn:hover { background:#1e40af; }
table { width:100%; border-collapse:collapse; border-radius:10px; overflow:hidden; }
th { background-color:rgba(31,41,55,0.9); color:white; padding:12px; font-size:14px; }
td { padding:10px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.2); }
tr:hover { background-color:rgba(255,255,255,0.1); }
.delete-btn { background-color:#dc2626; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
.delete-btn:hover { background-color:#b91c1c; }
.no-result { color:#f87171; font-weight:bold; margin-top:20px; text-align:center; }
.success-msg { color:#34d399; font-weight:bold; margin-top:20px; text-align:center; }
</style>
</head>
<body>

<div class="container">

    <!-- Â∞éË¶ΩÂàó -->
    <div class="navbar">
        <div><a href="/">üé¨ ÈõªÂΩ±ÂàóË°®</a></div>
        <div>
            {% if session.full_name %}
                ÊÇ®Â•ΩÔºå{{ session.full_name }} | <a href="/logout">ÁôªÂá∫</a>
            {% else %}
                <a href="/register">Ë®ªÂÜä</a>
                <a href="/login">ÁôªÂÖ•</a>
            {% endif %}
        </div>
    </div>

    <!-- Êü•Ë©¢ÂçÄÔºöÊú™ÁôªÂÖ•ÊâçÈ°ØÁ§∫ -->
    {% if not session.full_name %}
    <div class="search-card">
        <form id="search-form" method="post" style="width:100%; display:flex; align-items:center;">
            <input type="text" name="order_no" placeholder="Ë´ãËº∏ÂÖ•Ë®ÇÂñÆÁ∑®Ëôü" class="search-input" required>
            <button type="submit" class="search-btn">üîç Êü•Ë©¢</button>
        </form>
    </div>
    {% endif %}

    <!-- Ë®ÇÂñÆÁµêÊûú -->
    <div id="order-results">
        {% if results is defined %}
            {% if results|length > 0 %}
                <table>
                    <tr>
                        <th>Ë®ÇÂñÆÁ∑®Ëôü</th>
                        <th>Ë®ÇË≥º‰∫∫</th>
                        <th>ÈõªÂΩ±</th>
                        <th>Â†¥Ê¨°</th>
                        <th>Á•®Êï∏</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                    {% for r in results %}
                    <tr>
                        <td>{{ r.order_no }}</td>
                        <td>{{ r.customer_name }}</td>
                        <td>{{ r.title }}</td>
                        <td>{{ r.weekday }} {{ r.showtime }}</td>
                        <td>{{ r.tickets }}</td>
                        <td>
                            <form class="delete-form" data-order-no="{{ r.order_no }}">
                                <button type="button" class="delete-btn">ÂèñÊ∂à</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            {% else %}
                {% if session.full_name %}
                    <p class="no-result">üì≠ Â∞öÁÑ°Ë®ÇÂñÆ</p>
                {% else %}
                    {% if searched %}
                        <p class="no-result">‚ùå Êü•ÁÑ°Ê≠§Ë®ÇÂñÆ</p>
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}
    </div>

</div>

<script>
// AJAX Âà™Èô§Ë®ÇÂñÆ
document.querySelectorAll(".delete-form").forEach(form => {
    const btn = form.querySelector(".delete-btn");
    btn.addEventListener("click", async () => {
        const orderNo = form.dataset.orderNo;
        if(!confirm("Á¢∫ÂÆöË¶ÅÂèñÊ∂àÈÄôÁ≠ÜË®ÇÂñÆÂóéÔºü")) return;

        const res = await fetch(`/delete_order/${orderNo}`, { method:"POST" });
        const data = await res.json();

        if(data.success){
            const row = form.closest("tr");
            row.remove();
            const table = document.querySelector("#order-results table");
            if(table){
                const rows = table.querySelectorAll("tr");
                if(rows.length <= 1){
                    table.style.display="none";
                    const msg = document.createElement("p");
                    msg.textContent="‚úÖ Âà™Èô§ÊàêÂäü";
                    msg.className="success-msg";
                    const oldMsg = document.querySelector("#order-results .success-msg");
                    if(oldMsg) oldMsg.remove();
                    document.getElementById("order-results").appendChild(msg);
                }
            } else {
                const msg = document.createElement("p");
                msg.textContent="‚úÖ Âà™Èô§ÊàêÂäü";
                msg.className="success-msg";
                document.getElementById("order-results").appendChild(msg);
            }
        } else {
            alert("ÈåØË™§Ôºö" + data.message);
        }
    });
});
</script>

</body>
</html>